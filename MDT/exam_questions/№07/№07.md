# №09 Торговая система

Есть однотипные товары, они комплектуются в заказы, каждый заказ содержит один или несколько товаров в заданном количестве. Необходимо написать запросы (отчеты) по указанным ниже спецификациям.

## Схема БД (таблицы):

**Т1** - список товаров. Товары - однотипные (единицы измерения - одинаковые, штуки). Есть код товара, наименование и цена.

```sql
T1 (
    ItemId int primary key,
    Name varchar(80),
    Price decimal(5,2)
)
```

**Т2** - журнал заказов. Есть код заказа и время, когда он был отгружен. В таблице представлены данные для 24-х часового интервала.

```sql
T2 (
    OrderId int primary key,
    Dt datetime
)
```

**Т3** - заказы. Есть код заказа, код товара в заказе и его количество.

```sql
T3 (
    OrderId int,
    ItemId int,
    Qty int,
    primary key (OrderId, ItemId)
)
```

## Задачи:

### 1. Вывести список товаров, присутствуют в только в двух заказах.

```sql
SELECT 
    T1.ItemId,
    T1.Name,
    T1.Price
FROM T1
INNER JOIN T3 ON T1.ItemId = T3.ItemId
GROUP BY T1.ItemId, T1.Name, T1.Price
HAVING COUNT(DISTINCT T3.OrderId) = 2;

```

### 2. Вывести список заказов, где присутствует самый дешевый из проданных товаров.

```sql
SELECT DISTINCT
    T3.OrderId
FROM T3
JOIN T1 ON T3.ItemId = T1.ItemId
WHERE T1.Price = (
    SELECT MIN(T1.Price) 
    FROM T1
    WHERE T1.ItemId IN (SELECT DISTINCT ItemId FROM T3)
)
```

### 3. Вывести среднюю стоимость заказаов (выручка = Σ Qty × Price), где сумма отгруженных товаров(в штуках) больше средней суммы по всем заказам.

```sql
SELECT 
    AVG(OrderTotal) AS AvgOrderTotal
FROM (
    SELECT 
        T3.OrderId,
        SUM(T3.Qty * T1.Price) AS OrderTotal,
        SUM(T3.Qty) AS TotalQty
    FROM T3
    JOIN T1 ON T3.ItemId = T1.ItemId
    GROUP BY T3.OrderId
    HAVING SUM(T3.Qty) > (
        SELECT AVG(TotalQty)
        FROM (
            SELECT 
                T3_inner.OrderId,
                SUM(T3_inner.Qty) AS TotalQty
            FROM T3 AS T3_inner
            GROUP BY T3_inner.OrderId
        ) AS AvgQtySubquery
    )
) AS FilteredOrders;
```